<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Галерея Карла Брюллова</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --text-color: #333;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f9f9f9;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1.5rem 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        
        .search-container {
            width: 100%;
            margin-top: 1rem;
            transition: var(--transition);
        }
        
        #search-input {
            width: 100%;
            padding: 0.8rem 1rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            box-shadow: var(--shadow);
        }
        
        .search-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: var(--accent-color);
            border-radius: 50%;
            box-shadow: var(--shadow);
            z-index: 101;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .search-toggle:hover {
            transform: scale(1.05);
        }
        
        .search-toggle svg {
            width: 24px;
            height: 24px;
            fill: white;
        }
        
        .camera-toggle {
            display: none;
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #3498db;
            border-radius: 50%;
            box-shadow: var(--shadow);
            z-index: 101;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .camera-toggle:hover {
            transform: scale(1.05);
        }
        
        .camera-toggle svg {
            width: 24px;
            height: 24px;
            fill: white;
        }
        
        main {
            padding: 2rem 0;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .painting-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
        }
        
        .painting-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        .painting-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: #ddd;
        }
        
        .painting-info {
            padding: 1rem;
        }
        
        .painting-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        .painting-year {
            color: #666;
            font-size: 0.9rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .modal-content {
            background-color: white;
            max-width: 800px;
            margin: 2rem auto;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            padding: 1.5rem;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            margin-bottom: 1.5rem;
            background-color: #f5f5f5;
        }
        
        .painting-details {
            margin-bottom: 1.5rem;
        }
        
        .detail-item {
            margin-bottom: 0.8rem;
        }
        
        .detail-label {
            font-weight: bold;
            display: inline-block;
            width: 120px;
        }
        
        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        footer {
            background-color: var(--secondary-color);
            color: white;
            text-align: center;
            padding: 1.5rem 0;
            margin-top: 2rem;
        }
        
        @media (min-width: 768px) {
            .header-content {
                flex-wrap: nowrap;
            }
            
            .search-container {
                width: 50%;
                margin-top: 0;
            }
            
            h1 {
                margin-bottom: 0;
            }
            
            .modal-body {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1.5rem;
            }
            
            .modal-image {
                margin-bottom: 0;
            }
        }
        
        @media (max-width: 767px) {
            .search-container {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                background-color: white;
                padding: 1rem;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
                transform: translateY(100%);
                z-index: 99;
            }
            
            .search-container.active {
                transform: translateY(0);
            }
            
            .search-toggle {
                display: flex;
            }
            
            .camera-toggle {
                display: flex;
            }
            
            .header-content {
                justify-content: center;
            }
            
            h1 {
                text-align: center;
            }
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-style: italic;
            color: #666;
        }
        
        /* Стили для камеры */
        .camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .camera-content {
            background-color: white;
            max-width: 800px;
            margin: 2rem auto;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .camera-header {
            padding: 1.5rem;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .camera-body {
            padding: 1.5rem;
            text-align: center;
        }
        
        #camera-video {
            width: 100%;
            max-width: 500px;
            border-radius: 8px;
            background-color: #000;
        }
        
        #camera-canvas {
            display: none;
        }
        
        .camera-controls {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        
        .camera-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 4px;
            background-color: var(--primary-color);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .camera-btn:hover {
            background-color: var(--secondary-color);
        }
        
        .camera-btn.capture {
            background-color: var(--accent-color);
        }
        
        .camera-btn.capture:hover {
            background-color: #c0392b;
        }
        
        .search-results {
            margin-top: 2rem;
            text-align: left;
        }
        
        .search-result-item {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .search-result-item:hover {
            background-color: #f5f5f5;
        }
        
        .search-result-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        .search-result-info {
            flex: 1;
        }
        
        .search-result-title {
            font-weight: bold;
            margin-bottom: 0.3rem;
        }
        
        .search-result-year {
            color: #666;
            font-size: 0.9rem;
        }
        
        .search-result-confidence {
            font-size: 0.8rem;
            color: #3498db;
            font-weight: bold;
        }
        
        .color-preview {
            display: flex;
            gap: 2px;
            margin-top: 0.3rem;
        }
        
        .color-box {
            width: 15px;
            height: 15px;
            border-radius: 2px;
            border: 1px solid #ddd;
        }
        
        .debug-info {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #666;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <h1>Карл Брюллов: Галерея картин</h1>
                <div class="search-container" id="search-container">
                    <input type="text" id="search-input" placeholder="Поиск по названию картины...">
                </div>
            </div>
        </div>
    </header>
    
    <main>
        <div class="container">
            <div class="gallery" id="gallery-container">
                <!-- Картины будут загружены через JavaScript -->
            </div>
        </div>
    </main>
    
    <div class="search-toggle" id="search-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
    </div>
    
    <div class="camera-toggle" id="camera-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M18 10.48V6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4.48l4 3.98v-11l-4 3.98zm-2-.79V18H4V6h12v3.69z"/>
        </svg>
    </div>
    
    <div class="modal" id="painting-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Название картины</h2>
                <button class="close-btn" id="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <img class="modal-image" id="modal-image" src="" alt="Картина">
                <div class="painting-details" id="painting-details">
                    <!-- Детали будут загружены через JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно для камеры -->
    <div class="camera-modal" id="camera-modal">
        <div class="camera-content">
            <div class="camera-header">
                <h2>Поиск картины по фото</h2>
                <button class="close-btn" id="close-camera">&times;</button>
            </div>
            <div class="camera-body">
                <video id="camera-video" autoplay playsinline></video>
                <canvas id="camera-canvas"></canvas>
                <div class="camera-controls">
                    <button class="camera-btn capture" id="capture-btn">Сделать фото</button>
                    <button class="camera-btn" id="retake-btn" style="display:none;">Переснять</button>
                </div>
                <div class="search-results" id="search-results">
                    <!-- Результаты поиска будут отображаться здесь -->
                </div>
                <div class="debug-info" id="debug-info" style="display:none;">
                    <!-- Отладочная информация -->
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>wjartisan &copy; 2025</p>
        </div>
    </footer>
    
    <script>
        // Данные картин с реальными ссылками на изображения
        const paintings = [
  {
    "id": 1,
    "title": "Персей и Андромеда",
    "year": "Конец 1810-х",
    "image": "https://upload.wikimedia.org/wikipedia/commons/thumb/2/22/%D0%91%D1%80%D1%8E%D0%BB%D0%BB%D0%BE%D0%B2_%D0%9F%D0%B5%D1%80%D1%81%D0%B5%D0%B9_%D0%B8_%D0%90%D0%BD%D0%B4%D1%80%D0%BE%D0%BC%D0%B5%D0%B4%D0%B0.jpg/250px-%D0%91%D1%80%D1%8E%D0%BB%D0%BB%D0%BE%D0%B2_%D0%9F%D0%B5%D1%80%D1%81%D0%B5%D0%B9_%D0%B8_%D0%90%D0%BD%D0%B4%D1%80%D0%BE%D0%BC%D0%B5%D0%B4%D0%B0.jpg",
    "context": "Мифологическая картина на сюжет древнегреческого мифа о Персее и Андромеде из поэмы Овидия 'Метаморфозы'",
    "description": "Картина изображает кульминационный момент мифа, когда герой Персей, только что победивший морское чудовище, освобождает прикованную к скале Андромеду. Брюллов мастерски передает драматизм ситуации: напряжение только что закончившейся битвы, эмоциональное облегчение Андромеды и торжество героя. Композиция построена на контрасте могучей фигуры Персея в доспехах и хрупкой, изящной Андромеды.",
    "facts": "Одна из ранних академических работ Брюллова, созданная в период обучения в Императорской Академии художеств. Демонстрирует прекрасное владение академическим рисунком и интерес к классическим сюжетам. Картина написана маслом на холсте размером 43,7 × 28,6 см. В настоящее время находится в Государственном Русском музее в Санкт-Петербурге."
  },
  {
    "id": 2,
    "title": "Нарцисс, смотрящийся в воду",
    "year": "1819",
    "image": "https://upload.wikimedia.org/wikipedia/commons/thumb/4/4f/%D0%91%D1%80%D1%8E%D0%BB%D0%BB%D0%BE%D0%B2_%D0%9D%D0%B0%D1%80%D1%86%D0%B8%D1%81%D1%81.jpg/250px-%D0%91%D1%80%D1%8E%D0%BB%D0%BB%D0%BE%D0%B2_%D0%9D%D0%B0%D1%80%D1%86%D0%B8%D1%81%D1%81.jpg",
    "context": "Мифологическая картина на сюжет древнегреческого мифа о Нарциссе из поэмы Овидия 'Метаморфозы'",
    "description": "Брюллов изображает юного Нарцисса, влюбленного в собственное отражение в воде лесного источника. Художник тонко передает состояние самовлюбленного созерцания и трагическую обреченность героя. Композиция построена на изящном изгибе фигуры Нарцисса, склонившегося над водой. Мягкий свет, проникающий сквозь лесную листву, создает поэтическое, меланхолическое настроение.",
    "facts": "Картина создана в год окончания Брюлловым Академии художеств и демонстрирует влияние итальянского Возрождения. Работа отличается тонкой проработкой деталей и эмоциональной насыщенностью. Размеры картины: 162 × 209,5 см. Находится в Государственном Русском музее в Санкт-Петербурге. Картина была высоко оценена современниками за поэтичность и техническое совершенство."
  },
  {
    "id": 3,
    "title": "Явление Божие Аврааму у дуба мамврийского в виде трех ангелов",
    "year": "1821",
    "image": "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ab/%D0%91%D1%80%D1%8E%D0%BB%D0%BB%D0%BE%D0%B2_%D0%AF%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D0%90%D0%B2%D1%80%D0%B0%D0%B0%D0%BC%D1%83_%D1%82%D1%80%D0%B5%D1%85_%D0%B0%D0%BD%D0%B3%D0%B5%D0%BB%D0%BE%D0%B2_%D1%83_%D0%B4%D1%83%D0%B1%D0%B0_%D0%9C%D0%B0%D0%BC%D0%B2%D1%80%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B3%D0%BE.jpg/250px-%D0%91%D1%80%D1%8E%D0%BB%D0%BB%D0%BE%D0%B2_%D0%AF%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D0%90%D0%B2%D1%80%D0%B0%D0%B0%D0%BC%D1%83_%D1%82%D1%80%D0%B5%D1%85_%D0%B0%D0%BD%D0%B3%D0%B5%D0%BB%D0%BE%D0%B2_%D1%83_%D0%B4%D1%83%D0%B1%D0%B0_%D0%9C%D0%B0%D0%BC%D0%B2%D1%80%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B3%D0%BE.jpg",
    "context": "Библейский сюжет из Ветхого Завета (Книга Бытия, глава 18), изображающий явление Бога Аврааму у дубравы Мамре",
    "description": "Картина представляет монументальную композицию, изображающую трех ангелов, явившихся праотцу Аврааму в образе прекрасных юношей. Брюллов создает гармоничную группировку фигур, где центральный ангел благословляет Авраама, а два других обращены друг к другу в тихой беседе. Художник мастерски передает божественный свет, исходящий от ангелов, и благоговейное преклонение Авраама.",
    "facts": "Одна из первых крупных работ Брюллова на религиозную тему, созданная после окончания Академии. Демонстрирует мастерство художника в построении сложных многофигурных композиций. Размеры картины: 113 × 144 см. Находится в Государственном Русском музее. Картина отражает интерес Брюллова к монументальной живописи и библейским сюжетам в ранний период творчества."
  },
  {
    "id": 4,
    "title": "Портрет П. А. Кикина",
    "year": "1821—1822",
    "image": "https://upload.wikimedia.org/wikipedia/commons/thumb/c/ca/Karl_Brullov_08.JPG/250px-Karl_Brullov_08.JPG",
    "context": "Парадный портрет государственного деятеля и мецената Петра Андреевича Кикина",
    "description": "Брюллов создает выразительный портрет известного государственного деятеля и мецената, передавая не только внешнее сходство, но и характер модели. Кикин изображен в сдержанной, но элегантной позе, его взгляд выражает ум и уверенность. Художник тонко передает текстуру тканей, фактуру волос, добиваясь почти фотографической точности. Портрет отличается психологической глубиной и тщательной проработкой деталей.",
    "facts": "Петр Андреевич Кикин (1775-1834) был известным меценатом, коллекционером и одним из основателей Общества поощрения художников. Портрет создан в технике масляной живописи на холсте размером 82 × 71 см. Находится в Государственной Третьяковской галерее в Москве. Работа демонстрирует переход Брюллова от академических сюжетов к портретному жанру."
  },
  {
    "id": 5,
    "title": "Портрет М. А. Кикиной",
    "year": "1821—1822",
    "image": "https://upload.wikimedia.org/wikipedia/commons/thumb/4/47/Glrx-Kikin.jpg/250px-Glrx-Kikin.jpg",
    "context": "Парадный портрет Марии Ардалионовны Кикиной, жены П.А. Кикина",
    "description": "Парный портрет к портрету П.А. Кикина. Брюллов изображает Марию Ардалионовну с изяществом и тонким пониманием женской красоты. Модель представлена в элегантном платье с кружевным воротником, ее поза спокойна и величава. Художник мастерски передает нежные черты лица, мягкую улыбку и задумчивый взгляд. Портрет отличается гармоничным цветовым решением и тонкой светотеневой моделировкой.",
    "facts": "Мария Ардалионовна Кикина (урожденная Львова) была женой Петра Андреевича Кикина. Портрет выполнен маслом на холсте размером 82,6 × 71,7 см. Находится в Государственной Третьяковской галерее. Работа демонстрирует становление Брюллова как мастера психологического портрета и его умение передавать внутренний мир модели."
  }
];

        // Кэш для хранения цветовых сигнатур картин
        const paintingSignatures = new Map();

        // Функция для отображения картин в галерее
        function renderGallery(paintingsToRender) {
            const galleryContainer = document.getElementById('gallery-container');
            
            if (paintingsToRender.length === 0) {
                galleryContainer.innerHTML = '<div class="no-results">Картины по вашему запросу не найдены</div>';
                return;
            }
            
            galleryContainer.innerHTML = paintingsToRender.map(painting => `
                <div class="painting-card" data-id="${painting.id}">
                    <img class="painting-image" src="${painting.image}" alt="${painting.title}" loading="lazy">
                    <div class="painting-info">
                        <div class="painting-title">${painting.title}</div>
                        <div class="painting-year">${painting.year}</div>
                    </div>
                </div>
            `).join('');
            
            // Добавляем обработчики событий для карточек
            document.querySelectorAll('.painting-card').forEach(card => {
                card.addEventListener('click', function() {
                    const paintingId = parseInt(this.getAttribute('data-id'));
                    openPaintingModal(paintingId);
                });
            });
        }

        // Функция для открытия модального окна с информацией о картине
        function openPaintingModal(paintingId) {
            const painting = paintings.find(p => p.id === paintingId);
            if (!painting) return;
            
            document.getElementById('modal-title').textContent = painting.title;
            const modalImage = document.getElementById('modal-image');
            modalImage.src = painting.image;
            modalImage.alt = painting.title;
            
            const detailsContainer = document.getElementById('painting-details');
            detailsContainer.innerHTML = `
                <div class="detail-item">
                    <span class="detail-label">Год создания:</span>
                    <span>${painting.year}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Контекст:</span>
                    <span>${painting.context}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Описание:</span>
                    <span>${painting.description}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Факты:</span>
                    <span>${painting.facts}</span>
                </div>
            `;
            
            document.getElementById('painting-modal').style.display = 'block';
        }

        // Функция для поиска картин
        function searchPaintings(query) {
            const normalizedQuery = query.toLowerCase().trim();
            
            if (normalizedQuery === '') {
                return paintings;
            }
            
            return paintings.filter(painting => 
                painting.title.toLowerCase().includes(normalizedQuery)
            );
        }

        // Функция для переключения видимости поиска на мобильных устройствах
        function toggleSearch() {
            const searchContainer = document.getElementById('search-container');
            searchContainer.classList.toggle('active');
        }

        // Функции для работы с камерой
        let stream = null;
        let capturedImage = null;

        // Открытие камеры
        function openCamera() {
            document.getElementById('camera-modal').style.display = 'block';
            document.getElementById('search-results').innerHTML = '';
            document.getElementById('retake-btn').style.display = 'none';
            document.getElementById('debug-info').style.display = 'none';
            
            startCamera();
        }

        // Закрытие камеры
        function closeCamera() {
            document.getElementById('camera-modal').style.display = 'none';
            stopCamera();
        }

        // Запуск камеры
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                const video = document.getElementById('camera-video');
                video.srcObject = stream;
            } catch (err) {
                console.error('Ошибка доступа к камере:', err);
                alert('Не удалось получить доступ к камере. Пожалуйста, проверьте разрешения.');
            }
        }

        // Остановка камеры
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        // Сделать снимок
        function captureImage() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            capturedImage = canvas.toDataURL('image/jpeg');
            
            // Останавливаем камеру после снимка
            stopCamera();
            
            // Показываем кнопку для пересъемки
            document.getElementById('retake-btn').style.display = 'inline-block';
            
            // Ищем похожие картины
            searchByImage(canvas);
        }

        // Переснять фото
        function retakePhoto() {
            document.getElementById('search-results').innerHTML = '';
            document.getElementById('retake-btn').style.display = 'none';
            document.getElementById('debug-info').style.display = 'none';
            capturedImage = null;
            startCamera();
        }

        // Анализ изображения и получение цветовой сигнатуры
        function getImageSignature(canvas, sampleSize = 16) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Уменьшаем изображение для ускорения обработки
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = sampleSize;
            tempCanvas.height = sampleSize;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0, sampleSize, sampleSize);
            
            const imageData = tempCtx.getImageData(0, 0, sampleSize, sampleSize);
            const data = imageData.data;
            
            // Собираем гистограмму цветов
            const histogram = new Array(64).fill(0); // 4x4x4 гистограмма RGB
            
            for (let i = 0; i < data.length; i += 4) {
                const r = Math.floor(data[i] / 64);     // 0-3
                const g = Math.floor(data[i + 1] / 64); // 0-3
                const b = Math.floor(data[i + 2] / 64); // 0-3
                
                const index = r * 16 + g * 4 + b;
                histogram[index]++;
            }
            
            // Нормализуем гистограмму
            const total = sampleSize * sampleSize;
            const normalizedHistogram = histogram.map(val => val / total);
            
            // Получаем доминирующие цвета
            const dominantColors = [];
            const colorCounts = new Map();
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const color = `${r},${g},${b}`;
                
                colorCounts.set(color, (colorCounts.get(color) || 0) + 1);
            }
            
            // Сортируем цвета по частоте и берем топ-5
            const sortedColors = [...colorCounts.entries()]
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(entry => {
                    const [rgb, count] = entry;
                    const [r, g, b] = rgb.split(',').map(Number);
                    return { r, g, b, frequency: count / total };
                });
            
            return {
                histogram: normalizedHistogram,
                dominantColors: sortedColors,
                brightness: calculateBrightness(data),
                contrast: calculateContrast(data)
            };
        }

        // Расчет яркости изображения
        function calculateBrightness(data) {
            let sum = 0;
            for (let i = 0; i < data.length; i += 4) {
                sum += (data[i] + data[i + 1] + data[i + 2]) / 3;
            }
            return sum / (data.length / 4);
        }

        // Расчет контрастности изображения
        function calculateContrast(data) {
            const brightnessValues = [];
            for (let i = 0; i < data.length; i += 4) {
                brightnessValues.push((data[i] + data[i + 1] + data[i + 2]) / 3);
            }
            
            const avg = brightnessValues.reduce((a, b) => a + b) / brightnessValues.length;
            const variance = brightnessValues.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / brightnessValues.length;
            return Math.sqrt(variance);
        }

        // Сравнение двух цветовых сигнатур
        function compareSignatures(sig1, sig2) {
            // Сравнение гистограмм (расстояние Бхаттачария)
            let histogramDistance = 0;
            for (let i = 0; i < sig1.histogram.length; i++) {
                histogramDistance += Math.sqrt(sig1.histogram[i] * sig2.histogram[i]);
            }
            const histogramSimilarity = histogramDistance;
            
            // Сравнение доминирующих цветов
            let colorSimilarity = 0;
            for (let i = 0; i < Math.min(sig1.dominantColors.length, sig2.dominantColors.length); i++) {
                const color1 = sig1.dominantColors[i];
                const color2 = sig2.dominantColors[i];
                const distance = colorDistance(color1, color2);
                colorSimilarity += (1 - distance) * (color1.frequency + color2.frequency) / 2;
            }
            
            // Сравнение яркости и контраста
            const brightnessDiff = 1 - Math.abs(sig1.brightness - sig2.brightness) / 255;
            const contrastDiff = 1 - Math.abs(sig1.contrast - sig2.contrast) / 128;
            
            // Общая схожесть (взвешенная сумма)
            return histogramSimilarity * 0.4 + colorSimilarity * 0.3 + brightnessDiff * 0.15 + contrastDiff * 0.15;
        }

        // Расчет расстояния между цветами в RGB пространстве
        function colorDistance(color1, color2) {
            const dr = color1.r - color2.r;
            const dg = color1.g - color2.g;
            const db = color1.b - color2.b;
            return Math.sqrt(dr * dr + dg * dg + db * db) / 441.67; // Нормализованное расстояние (макс = √(255²+255²+255²) ≈ 441.67)
        }

        // Получение сигнатуры картины (с кэшированием)
        async function getPaintingSignature(painting) {
            if (paintingSignatures.has(painting.id)) {
                return paintingSignatures.get(painting.id);
            }
            
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    const signature = getImageSignature(canvas);
                    paintingSignatures.set(painting.id, signature);
                    resolve(signature);
                };
                img.onerror = function() {
                    // Если изображение не загружается, создаем базовую сигнатуру
                    const signature = {
                        histogram: new Array(64).fill(0.015625), // равномерное распределение
                        dominantColors: [{r: 128, g: 128, b: 128, frequency: 1}],
                        brightness: 128,
                        contrast: 50
                    };
                    paintingSignatures.set(painting.id, signature);
                    resolve(signature);
                };
                img.src = painting.image;
            });
        }

        // Поиск картины по изображению
        async function searchByImage(capturedCanvas) {
            const resultsContainer = document.getElementById('search-results');
            const debugInfo = document.getElementById('debug-info');
            
            resultsContainer.innerHTML = '<div class="loading">Анализируем изображение...</div>';
            debugInfo.style.display = 'none';
            
            try {
                // Получаем сигнатуру снятого изображения
                const capturedSignature = getImageSignature(capturedCanvas);
                
                // Сравниваем со всеми картинами
                const comparisons = [];
                
                for (const painting of paintings) {
                    const paintingSignature = await getPaintingSignature(painting);
                    const similarity = compareSignatures(capturedSignature, paintingSignature);
                    
                    comparisons.push({
                        painting: painting,
                        similarity: similarity
                    });
                }
                
                // Сортируем по схожести
                comparisons.sort((a, b) => b.similarity - a.similarity);
                
                // Показываем результаты
                resultsContainer.innerHTML = '<h3>Возможно, это одна из этих картин:</h3>';
                
                comparisons.slice(0, 5).forEach((comparison, index) => {
                    const similarityPercent = Math.round(comparison.similarity * 100);
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    
                    // Создаем превью доминирующих цветов
                    const colorPreview = comparison.painting.dominantColors 
                        ? comparison.painting.dominantColors.map(color => 
                            `<div class="color-box" style="background-color: rgb(${color.r}, ${color.g}, ${color.b})" title="RGB(${color.r},${color.g},${color.b})"></div>`
                        ).join('')
                        : '';
                    
                    resultItem.innerHTML = `
                        <img class="search-result-image" src="${comparison.painting.image}" alt="${comparison.painting.title}">
                        <div class="search-result-info">
                            <div class="search-result-title">${comparison.painting.title}</div>
                            <div class="search-result-year">${comparison.painting.year}</div>
                            <div class="color-preview">${colorPreview}</div>
                        </div>
                        <div class="search-result-confidence">${similarityPercent}%</div>
                    `;
                    resultItem.addEventListener('click', () => {
                        openPaintingModal(comparison.painting.id);
                        closeCamera();
                    });
                    resultsContainer.appendChild(resultItem);
                });
                
                // Показываем отладочную информацию
                debugInfo.style.display = 'block';
                debugInfo.innerHTML = `
                    <strong>Отладочная информация:</strong><br>
                    Яркость: ${Math.round(capturedSignature.brightness)}<br>
                    Контраст: ${Math.round(capturedSignature.contrast)}<br>
                    Доминирующие цвета: ${capturedSignature.dominantColors.map(c => `RGB(${c.r},${c.g},${c.b})`).join(', ')}
                `;
                
            } catch (error) {
                console.error('Ошибка при поиске:', error);
                resultsContainer.innerHTML = '<div class="no-results">Произошла ошибка при анализе изображения</div>';
            }
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Отображаем все картины при загрузке
            renderGallery(paintings);
            
            // Обработчик для поиска
            document.getElementById('search-input').addEventListener('input', function() {
                const searchResults = searchPaintings(this.value);
                renderGallery(searchResults);
            });
            
            // Закрытие модального окна
            document.getElementById('close-modal').addEventListener('click', function() {
                document.getElementById('painting-modal').style.display = 'none';
            });
            
            // Закрытие модального окна при клике вне его
            document.getElementById('painting-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // Обработчик для кнопки поиска на мобильных устройствах
            document.getElementById('search-toggle').addEventListener('click', toggleSearch);
            
            // Обработчик для кнопки камеры
            document.getElementById('camera-toggle').addEventListener('click', openCamera);
            
            // Закрытие камеры
            document.getElementById('close-camera').addEventListener('click', closeCamera);
            
            // Сделать снимок
            document.getElementById('capture-btn').addEventListener('click', captureImage);
            
            // Переснять фото
            document.getElementById('retake-btn').addEventListener('click', retakePhoto);
            
            // Закрытие поиска при клике вне его на мобильных устройствах
            document.addEventListener('click', function(e) {
                const searchContainer = document.getElementById('search-container');
                const searchToggle = document.getElementById('search-toggle');
                
                if (window.innerWidth <= 767 && 
                    searchContainer.classList.contains('active') && 
                    !searchContainer.contains(e.target) && 
                    !searchToggle.contains(e.target)) {
                    searchContainer.classList.remove('active');
                }
            });
            
            // Обработка ошибок загрузки изображений
            document.addEventListener('error', function(e) {
                if (e.target.tagName === 'IMG') {
                    e.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzc3NyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuKEoiBJbWFnZSBub3QgZm91bmQg4oSiPC90ZXh0Pjwvc3ZnPg==';
                    e.target.alt = 'Изображение не найдено';
                }
            }, true);
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Галерея Карла Брюллова</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --text-color: #333;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f9f9f9;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1.5rem 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        
        .search-container {
            width: 100%;
            margin-top: 1rem;
            transition: var(--transition);
        }
        
        #search-input {
            width: 100%;
            padding: 0.8rem 1rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            box-shadow: var(--shadow);
        }
        
        .search-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: var(--accent-color);
            border-radius: 50%;
            box-shadow: var(--shadow);
            z-index: 101;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .search-toggle:hover {
            transform: scale(1.05);
        }
        
        .search-toggle svg {
            width: 24px;
            height: 24px;
            fill: white;
        }
        
        .camera-toggle {
            display: none;
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #3498db;
            border-radius: 50%;
            box-shadow: var(--shadow);
            z-index: 101;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .camera-toggle:hover {
            transform: scale(1.05);
        }
        
        .camera-toggle svg {
            width: 24px;
            height: 24px;
            fill: white;
        }
        
        main {
            padding: 2rem 0;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .painting-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
        }
        
        .painting-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        .painting-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: #ddd;
        }
        
        .painting-info {
            padding: 1rem;
        }
        
        .painting-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        .painting-year {
            color: #666;
            font-size: 0.9rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .modal-content {
            background-color: white;
            max-width: 800px;
            margin: 2rem auto;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            padding: 1.5rem;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            margin-bottom: 1.5rem;
            background-color: #f5f5f5;
        }
        
        .painting-details {
            margin-bottom: 1.5rem;
        }
        
        .detail-item {
            margin-bottom: 0.8rem;
        }
        
        .detail-label {
            font-weight: bold;
            display: inline-block;
            width: 120px;
        }
        
        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        footer {
            background-color: var(--secondary-color);
            color: white;
            text-align: center;
            padding: 1.5rem 0;
            margin-top: 2rem;
        }
        
        @media (min-width: 768px) {
            .header-content {
                flex-wrap: nowrap;
            }
            
            .search-container {
                width: 50%;
                margin-top: 0;
            }
            
            h1 {
                margin-bottom: 0;
            }
            
            .modal-body {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1.5rem;
            }
            
            .modal-image {
                margin-bottom: 0;
            }
        }
        
        @media (max-width: 767px) {
            .search-container {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                background-color: white;
                padding: 1rem;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
                transform: translateY(100%);
                z-index: 99;
            }
            
            .search-container.active {
                transform: translateY(0);
            }
            
            .search-toggle {
                display: flex;
            }
            
            .camera-toggle {
                display: flex;
            }
            
            .header-content {
                justify-content: center;
            }
            
            h1 {
                text-align: center;
            }
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-style: italic;
            color: #666;
        }
        
        /* Стили для камеры */
        .camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .camera-content {
            background-color: white;
            max-width: 800px;
            margin: 2rem auto;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .camera-header {
            padding: 1.5rem;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .camera-body {
            padding: 1.5rem;
            text-align: center;
        }
        
        #camera-video {
            width: 100%;
            max-width: 500px;
            border-radius: 8px;
            background-color: #000;
        }
        
        #camera-canvas {
            display: none;
        }
        
        .camera-controls {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        
        .camera-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 4px;
            background-color: var(--primary-color);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .camera-btn:hover {
            background-color: var(--secondary-color);
        }
        
        .camera-btn.capture {
            background-color: var(--accent-color);
        }
        
        .camera-btn.capture:hover {
            background-color: #c0392b;
        }
        
        .search-results {
            margin-top: 2rem;
            text-align: left;
        }
        
        .search-result-item {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .search-result-item:hover {
            background-color: #f5f5f5;
        }
        
        .search-result-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        .search-result-info {
            flex: 1;
        }
        
        .search-result-title {
            font-weight: bold;
            margin-bottom: 0.3rem;
        }
        
        .search-result-year {
            color: #666;
            font-size: 0.9rem;
        }
        
        .search-result-confidence {
            font-size: 0.8rem;
            color: #3498db;
            font-weight: bold;
        }
        
        .color-preview {
            display: flex;
            gap: 2px;
            margin-top: 0.3rem;
        }
        
        .color-box {
            width: 15px;
            height: 15px;
            border-radius: 2px;
            border: 1px solid #ddd;
        }
        
        .debug-info {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #666;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <h1>Карл Брюллов: Галерея картин</h1>
                <div class="search-container" id="search-container">
                    <input type="text" id="search-input" placeholder="Поиск по названию картины...">
                </div>
            </div>
        </div>
    </header>
    
    <main>
        <div class="container">
            <div class="gallery" id="gallery-container">
                <!-- Картины будут загружены через JavaScript -->
            </div>
        </div>
    </main>
    
    <div class="search-toggle" id="search-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
    </div>
    
    <div class="camera-toggle" id="camera-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M18 10.48V6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4.48l4 3.98v-11l-4 3.98zm-2-.79V18H4V6h12v3.69z"/>
        </svg>
    </div>
    
    <div class="modal" id="painting-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Название картины</h2>
                <button class="close-btn" id="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <img class="modal-image" id="modal-image" src="" alt="Картина">
                <div class="painting-details" id="painting-details">
                    <!-- Детали будут загружены через JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно для камеры -->
    <div class="camera-modal" id="camera-modal">
        <div class="camera-content">
            <div class="camera-header">
                <h2>Поиск картины по фото</h2>
                <button class="close-btn" id="close-camera">&times;</button>
            </div>
            <div class="camera-body">
                <video id="camera-video" autoplay playsinline></video>
                <canvas id="camera-canvas"></canvas>
                <div class="camera-controls">
                    <button class="camera-btn capture" id="capture-btn">Сделать фото</button>
                    <button class="camera-btn" id="retake-btn" style="display:none;">Переснять</button>
                </div>
                <div class="search-results" id="search-results">
                    <!-- Результаты поиска будут отображаться здесь -->
                </div>
                <div class="debug-info" id="debug-info" style="display:none;">
                    <!-- Отладочная информация -->
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>wjartisan &copy; 2025</p>
        </div>
    </footer>
    
    <script>
        // Данные картин с реальными ссылками на изображения
        const paintings = [
  {
    "id": 1,
    "title": "Персей и Андромеда",
    "year": "Конец 1810-х",
    "image": "https://upload.wikimedia.org/wikipedia/commons/thumb/2/22/%D0%91%D1%80%D1%8E%D0%BB%D0%BB%D0%BE%D0%B2_%D0%9F%D0%B5%D1%80%D1%81%D0%B5%D0%B9_%D0%B8_%D0%90%D0%BD%D0%B4%D1%80%D0%BE%D0%BC%D0%B5%D0%B4%D0%B0.jpg/250px-%D0%91%D1%80%D1%8E%D0%BB%D0%BB%D0%BE%D0%B2_%D0%9F%D0%B5%D1%80%D1%81%D0%B5%D0%B9_%D0%B8_%D0%90%D0%BD%D0%B4%D1%80%D0%BE%D0%BC%D0%B5%D0%B4%D0%B0.jpg",
    "context": "Мифологическая картина на сюжет древнегреческого мифа о Персее и Андромеде из поэмы Овидия 'Метаморфозы'",
    "description": "Картина изображает кульминационный момент мифа, когда герой Персей, только что победивший морское чудовище, освобождает прикованную к скале Андромеду. Брюллов мастерски передает драматизм ситуации: напряжение только что закончившейся битвы, эмоциональное облегчение Андромеды и торжество героя. Композиция построена на контрасте могучей фигуры Персея в доспехах и хрупкой, изящной Андромеды.",
    "facts": "Одна из ранних академических работ Брюллова, созданная в период обучения в Императорской Академии художеств. Демонстрирует прекрасное владение академическим рисунком и интерес к классическим сюжетам. Картина написана маслом на холсте размером 43,7 × 28,6 см. В настоящее время находится в Государственном Русском музее в Санкт-Петербурге."
  },
  {
    "id": 2,
    "title": "Нарцисс, смотрящийся в воду",
    "year": "1819",
    "image": "https://upload.wikimedia.org/wikipedia/commons/thumb/4/4f/%D0%91%D1%80%D1%8E%D0%BB%D0%BB%D0%BE%D0%B2_%D0%9D%D0%B0%D1%80%D1%86%D0%B8%D1%81%D1%81.jpg/250px-%D0%91%D1%80%D1%8E%D0%BB%D0%BB%D0%BE%D0%B2_%D0%9D%D0%B0%D1%80%D1%86%D0%B8%D1%81%D1%81.jpg",
    "context": "Мифологическая картина на сюжет древнегреческого мифа о Нарциссе из поэмы Овидия 'Метаморфозы'",
    "description": "Брюллов изображает юного Нарцисса, влюбленного в собственное отражение в воде лесного источника. Художник тонко передает состояние самовлюбленного созерцания и трагическую обреченность героя. Композиция построена на изящном изгибе фигуры Нарцисса, склонившегося над водой. Мягкий свет, проникающий сквозь лесную листву, создает поэтическое, меланхолическое настроение.",
    "facts": "Картина создана в год окончания Брюлловым Академии художеств и демонстрирует влияние итальянского Возрождения. Работа отличается тонкой проработкой деталей и эмоциональной насыщенностью. Размеры картины: 162 × 209,5 см. Находится в Государственном Русском музее в Санкт-Петербурге. Картина была высоко оценена современниками за поэтичность и техническое совершенство."
  },
  {
    "id": 3,
    "title": "Явление Божие Аврааму у дуба мамврийского в виде трех ангелов",
    "year": "1821",
    "image": "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ab/%D0%91%D1%80%D1%8E%D0%BB%D0%BB%D0%BE%D0%B2_%D0%AF%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D0%90%D0%B2%D1%80%D0%B0%D0%B0%D0%BC%D1%83_%D1%82%D1%80%D0%B5%D1%85_%D0%B0%D0%BD%D0%B3%D0%B5%D0%BB%D0%BE%D0%B2_%D1%83_%D0%B4%D1%83%D0%B1%D0%B0_%D0%9C%D0%B0%D0%BC%D0%B2%D1%80%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B3%D0%BE.jpg/250px-%D0%91%D1%80%D1%8E%D0%BB%D0%BB%D0%BE%D0%B2_%D0%AF%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D0%90%D0%B2%D1%80%D0%B0%D0%B0%D0%BC%D1%83_%D1%82%D1%80%D0%B5%D1%85_%D0%B0%D0%BD%D0%B3%D0%B5%D0%BB%D0%BE%D0%B2_%D1%83_%D0%B4%D1%83%D0%B1%D0%B0_%D0%9C%D0%B0%D0%BC%D0%B2%D1%80%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B3%D0%BE.jpg",
    "context": "Библейский сюжет из Ветхого Завета (Книга Бытия, глава 18), изображающий явление Бога Аврааму у дубравы Мамре",
    "description": "Картина представляет монументальную композицию, изображающую трех ангелов, явившихся праотцу Аврааму в образе прекрасных юношей. Брюллов создает гармоничную группировку фигур, где центральный ангел благословляет Авраама, а два других обращены друг к другу в тихой беседе. Художник мастерски передает божественный свет, исходящий от ангелов, и благоговейное преклонение Авраама.",
    "facts": "Одна из первых крупных работ Брюллова на религиозную тему, созданная после окончания Академии. Демонстрирует мастерство художника в построении сложных многофигурных композиций. Размеры картины: 113 × 144 см. Находится в Государственном Русском музее. Картина отражает интерес Брюллова к монументальной живописи и библейским сюжетам в ранний период творчества."
  },
  {
    "id": 4,
    "title": "Портрет П. А. Кикина",
    "year": "1821—1822",
    "image": "https://upload.wikimedia.org/wikipedia/commons/thumb/c/ca/Karl_Brullov_08.JPG/250px-Karl_Brullov_08.JPG",
    "context": "Парадный портрет государственного деятеля и мецената Петра Андреевича Кикина",
    "description": "Брюллов создает выразительный портрет известного государственного деятеля и мецената, передавая не только внешнее сходство, но и характер модели. Кикин изображен в сдержанной, но элегантной позе, его взгляд выражает ум и уверенность. Художник тонко передает текстуру тканей, фактуру волос, добиваясь почти фотографической точности. Портрет отличается психологической глубиной и тщательной проработкой деталей.",
    "facts": "Петр Андреевич Кикин (1775-1834) был известным меценатом, коллекционером и одним из основателей Общества поощрения художников. Портрет создан в технике масляной живописи на холсте размером 82 × 71 см. Находится в Государственной Третьяковской галерее в Москве. Работа демонстрирует переход Брюллова от академических сюжетов к портретному жанру."
  },
  {
    "id": 5,
    "title": "Портрет М. А. Кикиной",
    "year": "1821—1822",
    "image": "https://upload.wikimedia.org/wikipedia/commons/thumb/4/47/Glrx-Kikin.jpg/250px-Glrx-Kikin.jpg",
    "context": "Парадный портрет Марии Ардалионовны Кикиной, жены П.А. Кикина",
    "description": "Парный портрет к портрету П.А. Кикина. Брюллов изображает Марию Ардалионовну с изяществом и тонким пониманием женской красоты. Модель представлена в элегантном платье с кружевным воротником, ее поза спокойна и величава. Художник мастерски передает нежные черты лица, мягкую улыбку и задумчивый взгляд. Портрет отличается гармоничным цветовым решением и тонкой светотеневой моделировкой.",
    "facts": "Мария Ардалионовна Кикина (урожденная Львова) была женой Петра Андреевича Кикина. Портрет выполнен маслом на холсте размером 82,6 × 71,7 см. Находится в Государственной Третьяковской галерее. Работа демонстрирует становление Брюллова как мастера психологического портрета и его умение передавать внутренний мир модели."
  }
];

        // Кэш для хранения цветовых сигнатур картин
        const paintingSignatures = new Map();

        // Функция для отображения картин в галерее
        function renderGallery(paintingsToRender) {
            const galleryContainer = document.getElementById('gallery-container');
            
            if (paintingsToRender.length === 0) {
                galleryContainer.innerHTML = '<div class="no-results">Картины по вашему запросу не найдены</div>';
                return;
            }
            
            galleryContainer.innerHTML = paintingsToRender.map(painting => `
                <div class="painting-card" data-id="${painting.id}">
                    <img class="painting-image" src="${painting.image}" alt="${painting.title}" loading="lazy">
                    <div class="painting-info">
                        <div class="painting-title">${painting.title}</div>
                        <div class="painting-year">${painting.year}</div>
                    </div>
                </div>
            `).join('');
            
            // Добавляем обработчики событий для карточек
            document.querySelectorAll('.painting-card').forEach(card => {
                card.addEventListener('click', function() {
                    const paintingId = parseInt(this.getAttribute('data-id'));
                    openPaintingModal(paintingId);
                });
            });
        }

        // Функция для открытия модального окна с информацией о картине
        function openPaintingModal(paintingId) {
            const painting = paintings.find(p => p.id === paintingId);
            if (!painting) return;
            
            document.getElementById('modal-title').textContent = painting.title;
            const modalImage = document.getElementById('modal-image');
            modalImage.src = painting.image;
            modalImage.alt = painting.title;
            
            const detailsContainer = document.getElementById('painting-details');
            detailsContainer.innerHTML = `
                <div class="detail-item">
                    <span class="detail-label">Год создания:</span>
                    <span>${painting.year}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Контекст:</span>
                    <span>${painting.context}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Описание:</span>
                    <span>${painting.description}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Факты:</span>
                    <span>${painting.facts}</span>
                </div>
            `;
            
            document.getElementById('painting-modal').style.display = 'block';
        }

        // Функция для поиска картин
        function searchPaintings(query) {
            const normalizedQuery = query.toLowerCase().trim();
            
            if (normalizedQuery === '') {
                return paintings;
            }
            
            return paintings.filter(painting => 
                painting.title.toLowerCase().includes(normalizedQuery)
            );
        }

        // Функция для переключения видимости поиска на мобильных устройствах
        function toggleSearch() {
            const searchContainer = document.getElementById('search-container');
            searchContainer.classList.toggle('active');
        }

        // Функции для работы с камерой
        let stream = null;
        let capturedImage = null;

        // Открытие камеры
        function openCamera() {
            document.getElementById('camera-modal').style.display = 'block';
            document.getElementById('search-results').innerHTML = '';
            document.getElementById('retake-btn').style.display = 'none';
            document.getElementById('debug-info').style.display = 'none';
            
            startCamera();
        }

        // Закрытие камеры
        function closeCamera() {
            document.getElementById('camera-modal').style.display = 'none';
            stopCamera();
        }

        // Запуск камеры
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                const video = document.getElementById('camera-video');
                video.srcObject = stream;
            } catch (err) {
                console.error('Ошибка доступа к камере:', err);
                alert('Не удалось получить доступ к камере. Пожалуйста, проверьте разрешения.');
            }
        }

        // Остановка камеры
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        // Сделать снимок
        function captureImage() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            capturedImage = canvas.toDataURL('image/jpeg');
            
            // Останавливаем камеру после снимка
            stopCamera();
            
            // Показываем кнопку для пересъемки
            document.getElementById('retake-btn').style.display = 'inline-block';
            
            // Ищем похожие картины
            searchByImage(canvas);
        }

        // Переснять фото
        function retakePhoto() {
            document.getElementById('search-results').innerHTML = '';
            document.getElementById('retake-btn').style.display = 'none';
            document.getElementById('debug-info').style.display = 'none';
            capturedImage = null;
            startCamera();
        }

        // Анализ изображения и получение цветовой сигнатуры
        function getImageSignature(canvas, sampleSize = 16) {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Уменьшаем изображение для ускорения обработки
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = sampleSize;
            tempCanvas.height = sampleSize;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0, sampleSize, sampleSize);
            
            const imageData = tempCtx.getImageData(0, 0, sampleSize, sampleSize);
            const data = imageData.data;
            
            // Собираем гистограмму цветов
            const histogram = new Array(64).fill(0); // 4x4x4 гистограмма RGB
            
            for (let i = 0; i < data.length; i += 4) {
                const r = Math.floor(data[i] / 64);     // 0-3
                const g = Math.floor(data[i + 1] / 64); // 0-3
                const b = Math.floor(data[i + 2] / 64); // 0-3
                
                const index = r * 16 + g * 4 + b;
                histogram[index]++;
            }
            
            // Нормализуем гистограмму
            const total = sampleSize * sampleSize;
            const normalizedHistogram = histogram.map(val => val / total);
            
            // Получаем доминирующие цвета
            const dominantColors = [];
            const colorCounts = new Map();
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const color = `${r},${g},${b}`;
                
                colorCounts.set(color, (colorCounts.get(color) || 0) + 1);
            }
            
            // Сортируем цвета по частоте и берем топ-5
            const sortedColors = [...colorCounts.entries()]
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(entry => {
                    const [rgb, count] = entry;
                    const [r, g, b] = rgb.split(',').map(Number);
                    return { r, g, b, frequency: count / total };
                });
            
            return {
                histogram: normalizedHistogram,
                dominantColors: sortedColors,
                brightness: calculateBrightness(data),
                contrast: calculateContrast(data)
            };
        }

        // Расчет яркости изображения
        function calculateBrightness(data) {
            let sum = 0;
            for (let i = 0; i < data.length; i += 4) {
                sum += (data[i] + data[i + 1] + data[i + 2]) / 3;
            }
            return sum / (data.length / 4);
        }

        // Расчет контрастности изображения
        function calculateContrast(data) {
            const brightnessValues = [];
            for (let i = 0; i < data.length; i += 4) {
                brightnessValues.push((data[i] + data[i + 1] + data[i + 2]) / 3);
            }
            
            const avg = brightnessValues.reduce((a, b) => a + b) / brightnessValues.length;
            const variance = brightnessValues.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / brightnessValues.length;
            return Math.sqrt(variance);
        }

        // Сравнение двух цветовых сигнатур
        function compareSignatures(sig1, sig2) {
            // Сравнение гистограмм (расстояние Бхаттачария)
            let histogramDistance = 0;
            for (let i = 0; i < sig1.histogram.length; i++) {
                histogramDistance += Math.sqrt(sig1.histogram[i] * sig2.histogram[i]);
            }
            const histogramSimilarity = histogramDistance;
            
            // Сравнение доминирующих цветов
            let colorSimilarity = 0;
            for (let i = 0; i < Math.min(sig1.dominantColors.length, sig2.dominantColors.length); i++) {
                const color1 = sig1.dominantColors[i];
                const color2 = sig2.dominantColors[i];
                const distance = colorDistance(color1, color2);
                colorSimilarity += (1 - distance) * (color1.frequency + color2.frequency) / 2;
            }
            
            // Сравнение яркости и контраста
            const brightnessDiff = 1 - Math.abs(sig1.brightness - sig2.brightness) / 255;
            const contrastDiff = 1 - Math.abs(sig1.contrast - sig2.contrast) / 128;
            
            // Общая схожесть (взвешенная сумма)
            return histogramSimilarity * 0.4 + colorSimilarity * 0.3 + brightnessDiff * 0.15 + contrastDiff * 0.15;
        }

        // Расчет расстояния между цветами в RGB пространстве
        function colorDistance(color1, color2) {
            const dr = color1.r - color2.r;
            const dg = color1.g - color2.g;
            const db = color1.b - color2.b;
            return Math.sqrt(dr * dr + dg * dg + db * db) / 441.67; // Нормализованное расстояние (макс = √(255²+255²+255²) ≈ 441.67)
        }

        // Получение сигнатуры картины (с кэшированием)
        async function getPaintingSignature(painting) {
            if (paintingSignatures.has(painting.id)) {
                return paintingSignatures.get(painting.id);
            }
            
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    const signature = getImageSignature(canvas);
                    paintingSignatures.set(painting.id, signature);
                    resolve(signature);
                };
                img.onerror = function() {
                    // Если изображение не загружается, создаем базовую сигнатуру
                    const signature = {
                        histogram: new Array(64).fill(0.015625), // равномерное распределение
                        dominantColors: [{r: 128, g: 128, b: 128, frequency: 1}],
                        brightness: 128,
                        contrast: 50
                    };
                    paintingSignatures.set(painting.id, signature);
                    resolve(signature);
                };
                img.src = painting.image;
            });
        }

        // Поиск картины по изображению
        async function searchByImage(capturedCanvas) {
            const resultsContainer = document.getElementById('search-results');
            const debugInfo = document.getElementById('debug-info');
            
            resultsContainer.innerHTML = '<div class="loading">Анализируем изображение...</div>';
            debugInfo.style.display = 'none';
            
            try {
                // Получаем сигнатуру снятого изображения
                const capturedSignature = getImageSignature(capturedCanvas);
                
                // Сравниваем со всеми картинами
                const comparisons = [];
                
                for (const painting of paintings) {
                    const paintingSignature = await getPaintingSignature(painting);
                    const similarity = compareSignatures(capturedSignature, paintingSignature);
                    
                    comparisons.push({
                        painting: painting,
                        similarity: similarity
                    });
                }
                
                // Сортируем по схожести
                comparisons.sort((a, b) => b.similarity - a.similarity);
                
                // Показываем результаты
                resultsContainer.innerHTML = '<h3>Возможно, это одна из этих картин:</h3>';
                
                comparisons.slice(0, 5).forEach((comparison, index) => {
                    const similarityPercent = Math.round(comparison.similarity * 100);
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    
                    // Создаем превью доминирующих цветов
                    const colorPreview = comparison.painting.dominantColors 
                        ? comparison.painting.dominantColors.map(color => 
                            `<div class="color-box" style="background-color: rgb(${color.r}, ${color.g}, ${color.b})" title="RGB(${color.r},${color.g},${color.b})"></div>`
                        ).join('')
                        : '';
                    
                    resultItem.innerHTML = `
                        <img class="search-result-image" src="${comparison.painting.image}" alt="${comparison.painting.title}">
                        <div class="search-result-info">
                            <div class="search-result-title">${comparison.painting.title}</div>
                            <div class="search-result-year">${comparison.painting.year}</div>
                            <div class="color-preview">${colorPreview}</div>
                        </div>
                        <div class="search-result-confidence">${similarityPercent}%</div>
                    `;
                    resultItem.addEventListener('click', () => {
                        openPaintingModal(comparison.painting.id);
                        closeCamera();
                    });
                    resultsContainer.appendChild(resultItem);
                });
                
                // Показываем отладочную информацию
                debugInfo.style.display = 'block';
                debugInfo.innerHTML = `
                    <strong>Отладочная информация:</strong><br>
                    Яркость: ${Math.round(capturedSignature.brightness)}<br>
                    Контраст: ${Math.round(capturedSignature.contrast)}<br>
                    Доминирующие цвета: ${capturedSignature.dominantColors.map(c => `RGB(${c.r},${c.g},${c.b})`).join(', ')}
                `;
                
            } catch (error) {
                console.error('Ошибка при поиске:', error);
                resultsContainer.innerHTML = '<div class="no-results">Произошла ошибка при анализе изображения</div>';
            }
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Отображаем все картины при загрузке
            renderGallery(paintings);
            
            // Обработчик для поиска
            document.getElementById('search-input').addEventListener('input', function() {
                const searchResults = searchPaintings(this.value);
                renderGallery(searchResults);
            });
            
            // Закрытие модального окна
            document.getElementById('close-modal').addEventListener('click', function() {
                document.getElementById('painting-modal').style.display = 'none';
            });
            
            // Закрытие модального окна при клике вне его
            document.getElementById('painting-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // Обработчик для кнопки поиска на мобильных устройствах
            document.getElementById('search-toggle').addEventListener('click', toggleSearch);
            
            // Обработчик для кнопки камеры
            document.getElementById('camera-toggle').addEventListener('click', openCamera);
            
            // Закрытие камеры
            document.getElementById('close-camera').addEventListener('click', closeCamera);
            
            // Сделать снимок
            document.getElementById('capture-btn').addEventListener('click', captureImage);
            
            // Переснять фото
            document.getElementById('retake-btn').addEventListener('click', retakePhoto);
            
            // Закрытие поиска при клике вне его на мобильных устройствах
            document.addEventListener('click', function(e) {
                const searchContainer = document.getElementById('search-container');
                const searchToggle = document.getElementById('search-toggle');
                
                if (window.innerWidth <= 767 && 
                    searchContainer.classList.contains('active') && 
                    !searchContainer.contains(e.target) && 
                    !searchToggle.contains(e.target)) {
                    searchContainer.classList.remove('active');
                }
            });
            
            // Обработка ошибок загрузки изображений
            document.addEventListener('error', function(e) {
                if (e.target.tagName === 'IMG') {
                    e.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzc3NyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuKEoiBJbWFnZSBub3QgZm91bmQg4oSiPC90ZXh0Pjwvc3ZnPg==';
                    e.target.alt = 'Изображение не найдено';
                }
            }, true);
        });
    </script>
</body>
</html>
